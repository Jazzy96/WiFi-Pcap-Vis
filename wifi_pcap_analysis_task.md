# Context
Filename: wifi_pcap_analysis_task.md
Created On: 2024-07-30
Created By: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
当前的抓包解析存在以下问题，请你参考gopacket-80211.md修复：
1. 从管理帧解析BSS的带宽、加密方式、HT/VHT Cap都有问题；
2. STA的Bitrate解析错误，应该是1201.1Mbps，但是解析出来最多24Mbps、6Mbps，看起来没有解析data帧；

# Project Overview
Project: wifi-pcap-demo
Relevant files: desktop_app/WifiPcapAnalyzer/frame_parser/parser.go, gopacket-80211.md
Goal: Fix WiFi frame parsing issues in parser.go.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- **Radiotap Parsing**: Initial parsing of Radiotap fields like MCS index, Short GI, and Bandwidth needs correction for accuracy, especially how `rt.MCS.Flags` are interpreted. The field `info.RadiotapMCSBw` currently stores 0 for 20MHz and 1 for 40MHz.
- **Management Frame IE Parsing**:
    - HT Capabilities (ID 45), VHT Capabilities (ID 191), RSN IE (ID 48), HT Operation (ID 61), VHT Operation (ID 192) are crucial.
    - Current code iterates through IEs but specific parsing logic for these complex IEs (especially capabilities) appears to be missing or incomplete (e.g., `TODO` comments for HT/VHT/HE).
    - RSN IE parsing for cipher suites and AKM seems to be partially implemented but might need verification for correctness and completeness in determining `EncryptionType`.
    - Bandwidth determination from HT/VHT Operation IEs needs to be robust.
- **STA Bitrate Calculation**:
    - Current `getRateMbps` relies on `frame.RadioTap.Rate` for legacy rates.
    - For HT/VHT/HE rates, it uses `info.RadiotapMCSIndex`, `info.IsShortGI`, `info.RadiotapMCSBw`, `info.RadiotapVHTNSS`.
    - The current max rate of 24Mbps suggests issues with HT/VHT rate calculation or that data frames are not being parsed with the correct parameters (e.g., NSS, wider bandwidths from VHT/HE are not considered).
    - `gopacket-80211.md` provides tables and formulas for these calculations.
- **File Structure**:
    - `parser.go` contains `parseRadiotap`, `ParseManagementFrame`, `ParseDataFrame`, `ParseControlFrame`, `ParseBeaconFrame`, `ParseProbeRespFrame`, etc.
    - Helper functions like `getRateMbps`, `decodeIEs`, `parseRSNIE` exist.
- **Dependencies**: `github.com/google/gopacket`

# Proposed Solution (Populated by INNOVATE mode)
The solution involves a multi-step correction and enhancement of `parser.go`:
1.  **Correct Radiotap Parsing**: Accurately parse MCS flags for Short GI and bandwidth (20/40MHz initially, with an eye towards VHT/HE bandwidths later).
2.  **Detailed IE Parsing**: Implement comprehensive parsing for key IEs in management frames: HT/VHT Capabilities, HT/VHT Operation, and RSN IE. This will involve decoding bitfields and specific structures within these IEs.
3.  **Update BSSInfo**: Ensure `BSSInfo` (from Beacons/ProbeResps) correctly reflects bandwidth and encryption derived from parsed IEs.
4.  **Revise Bitrate Calculation**: Update `getRateMbps` (or equivalent) to accurately calculate bitrates for Data frames, considering HT, VHT, and HE modes. This will require using MCS index, GI, bandwidth (20/40/80/160 MHz), and number of spatial streams (NSS) from Radiotap and VHT/HE capabilities/operation elements.

# Implementation Plan (Generated by PLAN mode)
Implementation Checklist:
1.  **定义/完善 IE 解析辅助函数**: (骨架已创建)
    *   在 `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go` 中创建或取消注释以下辅助函数。这些函数将接收原始IE字节 (`ieData []byte`) 和 `ParsedFrameInfo` 指针作为参数，并填充相应的结构体字段。
        *   `parseHTCapabilitiesIE(info *ParsedFrameInfo, ieData []byte)`
        *   `parseVHTCapabilitiesIE(info *ParsedFrameInfo, ieData []byte)`
        *   `parseRSNIE(info *ParsedFrameInfo, ieData []byte)`
        *   `parseHTOperationIE(info *ParsedFrameInfo, ieData []byte)`
        *   `parseVHTOperationIE(info *ParsedFrameInfo, ieData []byte)`
2.  **在主IE解析循环中调用辅助函数**: (已完成 - RSN, HT Op, VHT Op 的调用已添加，ID问题已规避)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   修改 `ParsePacket` 函数内部的IE解析循环 (`for currentIndex < len(iePayload)`):
        *   在 `switch ieID` 语句中，为相应的 `layers.Dot11InformationElementID...` 添加case，并调用上面定义的解析函数。
3.  **修正并完善带宽 (Bandwidth) 的确定逻辑**: (结构已实现，`strings.HasSuffix` 暂时注释)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   在 `ParsePacket` 函数的末尾，**替换** 当前简单基于 `ParsedVHTCaps != nil` 的带宽设置逻辑。
    *   新的逻辑应按以下优先级顺序确定 `info.Bandwidth` (字符串形式，如 "20MHz", "40MHz", "80MHz", "160MHz"):
        1.  VHT Operation IE
        2.  HT Operation IE
        3.  VHT Capabilities IE
        4.  HT Capabilities IE
        5.  Radiotap Fallback
        6.  Default
4.  **修正安全 (Security) 信息的确定逻辑**: (结构已就绪，待 `parseRSNIE` 填充)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   `parseRSNIE` 函数将负责填充 `info.Security`.
    *   确保在 `ParsePacket` 函数的末尾，如果 `info.Security` 仍然为空（即没有RSN IE），则检查 `dot11.Flags.WEP()` 来设置 "WEP"，或者默认为 "Open"。
5.  **填充IE解析函数 - `parseRSNIE`**: (已完成)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   实现 `parseRSNIE` 的完整逻辑，以从IE数据中提取版本、组密码、对偶密码套件计数和列表、AKM套件计数和列表，并根据这些信息（特别是AKM和对偶密码）设置 `info.Security` (例如 "WPA2-PSK-CCMP", "WPA3-SAE")。
6.  **填充IE解析函数 - `parseHTCapabilitiesIE`**: (已完成)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   实现 `parseHTCapabilitiesIE` 的完整逻辑，填充 `info.ParsedHTCaps` 结构中的所有相关字段 (如 ChannelWidth40MHz, ShortGI20MHz, ShortGI40MHz, SupportedMCSSet 等)。
7.  **填充IE解析函数 - `parseVHTCapabilitiesIE`**: (已完成)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   实现 `parseVHTCapabilitiesIE` 的完整逻辑，填充 `info.ParsedVHTCaps` 结构中的所有相关字段 (如 MaxMPDULength, SupportedChannelWidthSet, RxMCSMap, TxMCSMap 等)。
8.  **填充IE解析函数 - `parseHTOperationIE`**: (已完成, 并已联动修改带宽逻辑)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   实现 `parseHTOperationIE` 的完整逻辑，提取 PrimaryChannel, SecondaryChannelOffset, STAChannelWidth，并可能用于辅助 `info.Bandwidth` 的确定。
9.  **填充IE解析函数 - `parseVHTOperationIE`**: (已完成, 并已联动修改带宽逻辑)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   实现 `parseVHTOperationIE` 的完整逻辑，提取 VHTChannelWidth, ChannelCenterFrequencySegment0/1，这些将主要用于 `info.Bandwidth` 的确定，并填充 `info.ParsedVHTCaps` 中的相关操作字段。
10. **最终测试与验证第一个问题**: (进行中 - 等待用户反馈)
    *   测试管理帧解析BSS的带宽、加密方式、HT/VHT Cap是否正确。
    *   特别是针对用户报告的80MHz带宽和WPA2-PSK加密场景。
11. **修正Data帧速率解析 (原用户问题2)**: (后续)
    *   文件: `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`
    *   修改 `ParseDataFrame` 函数和 `getRateMbps` (或一个新的速率计算函数)。

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "实施清单第10项：最终测试与验证第一个问题 (等待用户反馈)"

# Task Progress (Appended by EXECUTE mode after each step completion)
*   [2024-07-30]
    *   Step: 1. 修正 Radiotap MCS 标志解析
    *   Modifications:
        *   `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`: Modified `parseRadiotap` function.
            *   Correctly parsed `rt.MCS.Flags` for Short GI using `flags.ShortGI()`.
            *   Correctly parsed `rt.MCS.Flags` for Bandwidth by evaluating the raw integer result of `flags.Bandwidth()` (0, 1, 2, or 3). Mapped value `1` to `info.RadiotapMCSBw = 1` (40MHz), and values `0`, `2`, `3` to `info.RadiotapMCSBw = 0` (20MHz), aligning with the existing structure of `info.RadiotapMCSBw`. This resolved previous linter errors related to undefined gopacket constants.
    *   Change Summary: Radiotap MCS flags (Short GI and Bandwidth) are now parsed more accurately by directly interpreting the output of gopacket helper methods.
    *   Reason: Executing plan step 1.
    *   Blockers: None.
    *   User Confirmation Status: Failure (Rework Needed) - Did not solve user-visible bandwidth issue due to overriding logic and incomplete IE parsing.
*No progress yet.*

*   [LATEST_DATETIME]
    *   Step: 1-4 (Refined Plan). Defined IE parser skeletons, added calls in main loop, structured Bandwidth and Security logic.
    *   Modifications:
        *   `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`: Added skeleton functions for IE parsing; updated main IE loop to call them; implemented new (structured) Bandwidth determination logic (with temp comment for `strings.HasSuffix`); confirmed Security logic structure is okay.
    *   Change Summary: Foundational work for detailed IE parsing is complete. Core logic for Bandwidth/Security determination is structured but awaits full IE data.
    *   Reason: Executing refined plan steps 1-4.
    *   Blockers: `strings.HasSuffix` import issue temporarily worked around by commenting out code. `gopacket` constants for HT/VHT Operation IE IDs were problematic, worked around using numerical IDs.
    *   User Confirmation Status: [Pending Confirmation for steps 1-4 foundation]

*   [LATEST_DATETIME]
    *   Step: 5-9 (Refined Plan). Filled RSNIE, HT Capabilities, VHT Capabilities, HT Operation, VHT Operation IE parsing functions. Adjusted main bandwidth logic to use new fields from HT/VHT Operation parsers.
    *   Modifications:
        *   `desktop_app/WifiPcapAnalyzer/frame_parser/parser.go`: Implemented detailed parsing logic within `parseRSNIE`, `parseHTCapabilitiesIE`, `parseVHTCapabilitiesIE`, `parseHTOperationIE`, and `parseVHTOperationIE`. Added `OperatingAt40MHz` field to `HTCapabilityInfo` and updated bandwidth determination logic in `ParsePacket` to consume it correctly. `strings` import issue remains worked around.
    *   Change Summary: Parsing capabilities for key management frame IEs are now significantly enhanced. Bandwidth and security determination should be more accurate.
    *   Reason: Executing refined plan steps 5-9.
    *   Blockers: `strings` import issue workaround is still in place.
    *   User Confirmation Status: [Pending Confirmation for steps 5-9 implementations]

# Final Review (Populated by REVIEW mode)
*Not yet reviewed.* 